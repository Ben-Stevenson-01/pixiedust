<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PixieGateway Admin Console</title>
    <meta name="description" content="PixieGateway Admin Console">
    <meta name="author" content="PixieDust">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.min.css" type="text/css" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    
    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js" integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script>
        var displayStats = {}
        $( document ).ready(function() {
            function updateStats(){
                $.get({
                    url: "/stats",
                    contentType: "text/plain",
                    success: function(data){
                        for (var key in data){
                            var runStats = data[key]["run_stats"];
                            var appStats = data[key]["app_stats"];
                            var userStats = data[key]["users"];
                            var stats = {
                                "kernel_name": runStats["kernel_name"],
                                "status": runStats["status"],
                                "busy_ratio": Math.round(runStats["busy_ratio"] * 10)/10 + "%",
                                "apps": appStats.join(", ") || "None",
                                "users": userStats.count
                            }
                            if (!displayStats[key]){
                                displayStats[key] = stats;
                                $("#tbody").append(
                                    "<tr id=\""+key+"\"> "+
                                        "<td id=\"kernel_name\">" + stats["kernel_name"] + "</td>" +
                                        "<td id=\"status\">" + stats["status"] + "</td>" +
                                        "<td id=\"busy_ratio\">" + stats["busy_ratio"] + "</td>" +
                                        "<td id=\"apps\">" + stats["apps"] + "</td>" +
                                        "<td id=\"users\">" + stats["users"] + "</td>" +
                                    "</tr>"
                                )
                            }else{
                                for (var k in displayStats[key]){
                                    if (displayStats[key][k] !== stats[k]){
                                        displayStats[key][k] = stats[k];
                                        $("#" + key + " #"+k).html( stats[k] );
                                    }
                                }
                            }
                        }

                        //Check for keys that needs to be removed
                        Object.keys(displayStats).forEach(function(key){
                            if (!data[key]){
                                delete(displayStats[key]);
                                $("#" + key).remove();
                            }
                        });
                    }
                });
            }

            setInterval(updateStats, 1000);
        });
    </script>
</head>
<body>
    <div class="container">
        <center><h2>PixieGateway Statistics</h2></center>
        <br/>          
        <table class="table">
            <thead>
                <tr>
                    <th>Kernel Name</th>
                    <th>Status</th>
                    <th>Busy Ratio</th>
                    <th>Running Apps</th>
                    <th>Users Count</th>
                </tr>
            </thead>
            <tbody id="tbody">
            </tbody>
        </table>
    </div>
</body>
</html>